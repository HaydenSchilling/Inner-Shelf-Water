---
title: "Data Exploration"
author: "Peter Yates"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: html_document
---

### This document applies the protocol for data exploration by Zuur et al 2010 (doi 10.1111/j.2041-210X.2009.00001.x).

This includes:

* Collinearity
* Relationships between x variables
* Relationships between x and y variables
* Interactions - are any apparent and is there enough data to test for them?
* Independence - I suspect these data violate this assumption hence I'll include a spatial autocorrelation term and looking for spatial dependence in model residuals.
* Outliers in x and y and x~y
* Homogeneity and balance accross factor levels and two-way factor-level combinations
* Occurence of zeros and NAs

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning =F)
```

```{r, include=F}
#Load packages
lapply(c("R.matlab","knitr","RODBC","MASS", 
         "tweedie", "nlme", "statmod","mgcv", 
         "raster", "lattice", "ggplot2",
         "fields","rgdal", "plyr","dplyr",
         "gdata", "gstat","car","visreg","tidyr",
         "plotrix","hexbin", "R.matlab", "ggmap","viridis",
         "weathermetrics", "chron", "RColorBrewer","lattice",
         "ncdf4", "geosphere", "maptools", "sp", "oce", "pracma",
         "gridExtra", "maps", "mapdata", "sp", "rgeos", "lubridate"), require, character.only = TRUE)
#Source Highland Statistics code
source("code/HighstatLibV6.R")

#read data
df	<- read.csv("data/IntegratedData_300419.csv", header=TRUE, sep=",", dec=".", fill=TRUE)

#select variables
df <- df %>% select(datestr, datenum, Lat, Lon, site, site2, Depth, Temp, Salt, NBSSSlope,NBSSIntercept, NBSSRsq, Biomass, Abundance, GeoMn, fluorescence, oxygen, salinity, saldiff, temperature, tempdiff, Nitrate, Phosphate, Silicate, U, V, distance, GA_depth2, slope, D_coast)
#remove ambiguity
df$CTDtemp <- df$temperature
df$temperature <- NULL
df$CTDsalinity <- df$salinity
df$salinity <- NULL
#remove data from 10th September
#make StartUTC a date:
df$time <- as.POSIXct(df$datestr, tz = "UTC", format =  "%d-%b-%Y %H:%M:%S", optional=F)
#remove second tow at North Solitary on 10th September
df$date <- day(df$time) #all rows are september
df<- df %>% dplyr::filter(date != 10)

#filter biomass
df<- df %>% dplyr::filter(Biomass < 2000) 
```

```{r, include = F}
#create Vbin, Ubin at Dbin
#v: <-0.6 strong southward /// -0.6<v<-0.3 average southward /// -0.3<v<0.3 weak /// 0.3<v<0.6 average northward  /// 0.6<v strong northward
df <- df %>%
  dplyr::mutate(Vbin = ifelse(V < -0.6, "Strong_S",
                                  ifelse(between(V, -0.6, -0.3), "Average_S",
                                         ifelse(between(V, -0.30001,0.3),"Weak_NS", 
                                                ifelse(between(V, 0.30001,0.6), "Average_N",
                                                       ifelse(V > 0.6, "Strong_N","error"))))))

#u: <-0.6 strong westward /// -0.6<u<-0.3 average westward /// -0.3<u<0.3 weak /// 0.3<v<0.6 average eastward  /// 0.6<u strong eastward
df <- df %>%
  dplyr::mutate(Ubin = ifelse(U < -0.6, "Strong_W",
                                  ifelse(between(U, -0.6, -0.3), "Average_W",
                                         ifelse(between(U, -0.30001,0.3),"Weak_EW", 
                                                ifelse(between(U, 0.30001,0.6), "Average_E",
                                                       ifelse(U > 0.6, "Strong_E","error"))))))
#Dbin
plot(table(df$Depth))
df <- df %>%
  dplyr::mutate(Dbin = ifelse(between(Depth, 0, 25), "0_25",
                                  ifelse(between(Depth, 26, 55), "26_55",
                                         ifelse(between(Depth, 56,85),"56_85", 
                                                ifelse(between(Depth, 86,115), "85_115", "error")))))
df$Dbin <- as.factor(df$Dbin)
#plot(df$Depth, df$Dbin, col=df$Dbin)
#table(df$Dbin, useNA = "always")
#plot(df[df$site2 == "DH",]$Lon, -df[df$site2 == "DH",]$Depth, col=df[df$site2 == "DH",]$Dbin)
```

```{r}
Chl <- c(1.1796725,
    0.8578775,
    0.51298,
    0.5505,
    0.4280475,
    0.891985,
    1.273043333,
    1.670508333,
    0.51120875,
    1.001765,
    0.866155,
    0.7128275,
    0.70814875,
    0.06619125,
    2.1826175,
    2.1050925,
    1.8943175,
    1.2405825,
    0.88925375,
    1.034285,
    0.87250875,
    0.9854775,
    1.0142125,
    1.2324425,
    0.57284625,
    0.67676,
    0.841388333,
    3.39752)
fluorescence <- c(57.74,
54.74,
53.66,
54.95,
55.57,
57.4,
58.37,
62.83,
56.38,
57.69,
56.86,
55.64,
56.69,
59.59,
58.88,
61.9,
62.38,
62.75,
56.59,
57.06,
56.82,
55.85,
55.99,
60.61,
54.96,
56.41,
56,
62.36)

mdl <- lm(Chl ~ fluorescence)
summary(mdl)
plot(x=fluorescence, y=Chl)
abline(lm(Chl ~ fluorescence))

new <- data.frame(fluorescence = df$fluorescence)
chla <- predict(object = mdl, newdata = new, se.fit = TRUE)
df$chla <- chla$fit


pred.w.plim <- predict(mdl, new, interval="prediction")
pred.w.clim <- predict(mdl, new, interval="confidence")
matplot(new$fluorescence,cbind(pred.w.clim, pred.w.plim[,-1]),
        lty=c(1,2,2,3,3), type="l", ylab="predicted y")



```



### Relationships between variables

#### Scatterplots and Pearson correlations amoung continuous x vars

NB: Order of the plots is from North - South (CB, EH, NS, DH), followed by all sites pooled. CB did not have a CTD tow done hence it's pairplot contains fewer variables.
Based on these plots I am removing:

* Salt (as measured by the SeaSoar. It is correlated with Temp),
* D_coast (correlated with GA_depth),
* Phosphate and Silicate (correlated with Nitrate).

Keep an eye on:

* fluorescense~oxygen (oxygen is omitted later)
* fluorescense~nitrate (all good, actually I ommit Nitrate later based on variance inflation factors)
* Temp~nitrate (ditto)

```{r,echo=F, fig.height = 10, fig.width =15}
MyVar <- c("Temp","Salt", "fluorescence","oxygen", "Nitrate","Phosphate", "Silicate", "GA_depth2", "D_coast")
MyVarCB <- c("Temp","Salt", "GA_depth2", "D_coast")

#pdf('3plots/Pairs.pdf', width = 20, height =15)
Mypairs(df[df$site2 == "CB", MyVarCB])
Mypairs(df[df$site2 == "EH", MyVar])
Mypairs(df[df$site2 == "NS", MyVar])
Mypairs(df[df$site2 == "DH", MyVar])
Mypairs(df[, MyVar])
#dev.off()
```


#### Variance inflation factors (should not be > 3)
The VIF of a predictor is a measure for how easily it is predicted from a linear regression using the other predictors.
Ask stat: does Lon and site need to be here? VIF for categorical? Does site and Dbin need to be added OUTSIDE? i'm actually not interested in Depth...just want to account for it...(?)
```{r, echo=T}
MyVar2 <- c("Temp", "fluorescence","oxygen", "Nitrate", "GA_depth2", "Lon")
corvif(df[,MyVar2])
#remove nitrate
MyVar2b <- c("Temp", "fluorescence","oxygen", "GA_depth2", "Lon")
corvif(df[,MyVar2b])

#140519
MyVar2b <- c("Temp", "fluorescence","oxygen", "Nitrate", "GA_depth2", "Vbin", "Dbin", "site2")
corvif(df[,MyVar2b])
MyVar2b <- c("Temp", "fluorescence", "GA_depth2", "Vbin", "Dbin")
corvif(df[,MyVar2b])
MyVar2b <- c("Temp", "fluorescence", "GA_depth2", "Dbin")
corvif(df[,MyVar2b])


MyVar2b <- c("Temp", "fluorescence","oxygen", "Nitrate", "GA_depth2", "Vbin", "Dbin")
corvif(df[,MyVar2b])

MyVar2b <- c("Temp", "fluorescence", "GA_depth2", "Dbin", "Vbin")
corvif(df[,MyVar2b])

MyVar2b <- c("Temp", "fluorescence", "GA_depth2", "Dbin")
corvif(df[,MyVar2b])

```

Decision: remove Nitrate (the one with  the highest VIF value) which makes VIF all under 3.062
```{r, echo=FALSE}
MyVar3 <- c("Temp", "fluorescence", "GA_depth2", "oxygen")
corvif(df[,MyVar3])



#what if I instead remove oxygen first? (because I do later)
#MyVar2 <- c("Temp", "fluorescence","oxygen", "Nitrate", "GA_depth2")
#corvif(df[,MyVar2])
#MyVar3 <- c("Temp", "fluorescence", "GA_depth2", "Nitrate")
#corvif(df[,MyVar3])
#this doesn't make sense because (a) Nitrate had the highest VIF initially and (b) VIF would still be too high for Temp.
```


### Collinearity between categorical and continuous X vars (Dbin, Vbin, Ubin, slope, site)

* Decision: remove seafloor slope (it is correlated with GA_depth, see the final figure).
* What about Dbin~oxygen and Dbin~fluorescence? Decision: revisting the pairplots above there is collinearity between oxygen and fluoro. Decision: remove oxygen (and then I could probably get away with including fluoro).
*especially if I include a corgaus of GA_depth2 and longitude by site.

Dbin (depth bin 1-5). Note that I am not planning to use Dbin anymore. Dbin goes into the corgaus.
\newline

```{r, echo=FALSE, fig.height = 6, fig.width =7}
#pdf('3plots/categorial covariates.pdf', width = 6, height =5)
Mybwplot(df, MyVar3, "Dbin") #oxygen and fluoro


ggplot(df, aes(x=Dbin, y=fluorescence, color=site2)) +
  geom_jitter()
```

Vbin
(note the potential correlation between Temp and alongshore current. Makes sense - warmer water with southerly current)
\newline

```{r, echo=FALSE, fig.height = 6, fig.width =7}
Mybwplot(df, MyVar3, "Vbin")
```

Ubin
\newline

```{r, echo=FALSE, fig.height = 6, fig.width =7}
Mybwplot(df, MyVar3, "Ubin")
```

Site
\newline

```{r, echo=FALSE, fig.height = 6, fig.width =7}
Mybwplot(df, MyVar3, "site2")
```

Seafloor slope
\newline

```{r, echo=FALSE, fig.height = 6, fig.width =7}
Mybwplot(df, MyVar3, "slope")
#dev.off()
```

## Confounding between categorical X variables (Dbin, Vbin, Ubin, site)

All levels do have enough observations (10-15). Hence they are balanced in one dimension.

However, below are tables of all two-way factor level combinations. There are some issues here.

* Ubin is entirely determinable by site
* Dbin 5 is only at NS.
* Ubin can be determined based on Vbin and vice versa.
* Weak_NS only at DH. CB only Stong_S

Decision: Site is a key variable yet it is confounded with Ubin and Vbin. I need to exclude Ubin and Vbin. This will also solve my issues with the NA's in these variables.

```{r, echo= F}
table(df$Dbin, df$Vbin)
#table(df$Dbin, df$Ubin)
table(df$Dbin, df$site) #Dbin 5 is only at NS
#table(df$Vbin, df$Ubin) #Ubin can be determined based on Vbin and vice versa.
table(df$Vbin, df$site) #Weak_NS only at DH. CB only Stong_S
#table(df$Ubin, df$site) #Ubin can be determined based on site. drop Ubin.
```

### Relationships between X and Y

#### Continuous X variables

NB: Order of the plots is from North - South (CB, EH, NS, DH), followed by all sites pooled.
NB: Some non-linear relationships are apparent.

```{r, echo=F, fig.height = 10, fig.width =15}
MyVar4 <- c("Biomass", "NBSSSlope", "NBSSIntercept", "Abundance","GeoMn","Temp","fluorescence","oxygen","GA_depth2" )
MyVar4CB <- c("Biomass", "NBSSSlope", "NBSSIntercept", "Abundance","GeoMn","Temp","GA_depth2")
#pdf('3plots/response variable plots.pdf', width = 16, height =10)
Mypairs(df[df$site2 == "CB",MyVar4CB])
Mypairs(df[df$site2 == "EH",MyVar4])
Mypairs(df[df$site2 == "NS",MyVar4])
Mypairs(df[df$site2 == "DH",MyVar4])
Mypairs(df[,MyVar4])
#dev.off()
```

#### Categorical X Variables

These plots are for Dbin and site, repectively.
Also to check for homogeneity across factor levels.

Dbin
```{r, echo=F, fig.height = 5, fig.width =5}
MyYVar2 <- c("Biomass", "NBSSSlope", "NBSSIntercept", "Abundance", "GeoMn")
#pdf('3plots/response variable V categorical.pdf', width = 6, height =6)
Mybwplot(df,MyYVar2,"Dbin")
```

Vbin
```{r, echo=F, fig.height = 5, fig.width =5}
Mybwplot(df,MyYVar2 ,"Vbin")
```

Ubin
```{r, echo=F, fig.height = 5, fig.width =5}
Mybwplot(df,MyYVar2 ,"Ubin")
```

Site
```{r, echo=F, fig.height = 5, fig.width =5}
Mybwplot(df,MyYVar2 ,"site2")
#dev.off()
```

### Outliers

#### Outliers in X variables (there are none)
NB: Order of the plots is from North - South (CB, EH, NS, DH), followed by all sites pooled.
```{r, echo=F, fig.height = 5, fig.width =5}
#outliers in x
#pdf('3plots/Dotplot_x.pdf', width = 10, height =7)
Mydotplot(df[df$site2 == "CB",MyVar4[5:8]])
Mydotplot(df[df$site2 == "EH",MyVar4[5:8]])
Mydotplot(df[df$site2 == "NS",MyVar4[5:8]])
Mydotplot(df[df$site2 == "DH",MyVar4[5:8]])
Mydotplot(df[,MyVar4[5:8]])
#dev.off()
```

### Outliers in y

I decide to filter data to Biomass to < 2000. Everything else looks ok.
NB: Order of the plots is from North - South (CB, EH, NS, DH), followed by all sites pooled.
```{r, echo=F, fig.height = 5, fig.width =5}
MyYVar3 <- c("Biomass", "NBSSSlope", "NBSSIntercept", "Abundance", "GeoMn", "NBSSRsq")

#pdf('3plots/Dotplot_y.pdf', width = 10, height =7)
Mydotplot(df[df$site2 == "CB",MyYVar3])
Mydotplot(df[df$site2 == "EH",MyYVar3])
Mydotplot(df[df$site2 == "NS",MyYVar3])
Mydotplot(df[df$site2 == "DH",MyYVar3])
Mydotplot(df[,MyYVar3])
#dotchart(df$Biomass, main = "Biomass all sites")
#dev.off()

#filter biomass
df<- df %>% dplyr::filter(Biomass < 2000) #i.e. 8
```

### Zeros in Y variables
Decision: Data do not require special consideration regarding zero inflation
```{r}
sum(df$Biomass == 0)
sum(df$NBSSSlope == 0)
sum(df$NBSSIntercept == 0)
sum(df$Abundance == 0)
sum(df$GeoMn == 0)
```

### Interactions?

Below the colours correspond to depth bin. Looks like there are some interaction involving Dbin and site.

Ask stat about the second plot!

```{r,echo=F, fig.height = 5, fig.width =5}
#pdf('3plots/PairsFoci.pdf', width = 5, height =5)
plot(df[df$site2 == "EH",]$Temp ~ df[df$site2 == "EH",]$oxygen, col = df[df$site2 == "EH",]$Dbin, main="EH")
#dev.off()

plot(df$Temp ~ df$fluorescence, col = df$site2, main="col=site")

plot(df$Temp, col = df$site2, main="all sites")
ggplot(df, aes(x=site2, y=Temp, color=site2)) +
  geom_jitter()

ggplot(df, aes(x=Dbin, y=Temp, color=Dbin)) +
  geom_jitter()

ggplot(df, aes(x=Vbin, y=Temp, color=Vbin)) +
  geom_jitter()
```

Is there enough data to test for interactions, especially involing Dbin?

Dbin~Temp looks a bit patchy!

```{r, echo=F, fig.height = 4, fig.width =8, message=F, include=TRUE, results="hide"}
coplot(Biomass ~ Temp | site2,
       data = df,
       panel = function(x, y, ...) {
         tmp <- lm(y ~ x, na.action = na.omit)
         abline(tmp)
         points(x, y) }, rows = 1)

coplot(NBSSSlope ~ Temp | site2,
       data = df,
       panel = function(x, y, ...) {
         tmp <- lm(y ~ x, na.action = na.omit)
         abline(tmp)
         points(x, y) }, rows = 1)

coplot(Biomass ~ Temp | Dbin,
       data = df,
       panel = function(x, y, ...) {
         tmp <- lm(y ~ x, na.action = na.omit)
         abline(tmp)
         points(x, y) }, rows = 1)

coplot(NBSSSlope ~ Temp | Dbin,
       data = df,
       panel = function(x, y, ...) {
         tmp <- lm(y ~ x, na.action = na.omit)
         abline(tmp)
         points(x, y) }, rows = 1)

coplot(Biomass ~ fluorescence | site2,
       data = df[df$site2 != "CB",],
       panel = function(x, y, ...) {
         tmp <- lm(y ~ x, na.action = na.omit)
         abline(tmp)
         points(x, y) }, rows = 1)

coplot(NBSSSlope ~ fluorescence | site2,
       data = df[df$site2 != "CB",],
       panel = function(x, y, ...) {
         tmp <- lm(y ~ x, na.action = na.omit)
         abline(tmp)
         points(x, y) }, rows = 1)

coplot(Biomass ~ fluorescence | Dbin,
       data = df[df$site2 != "CB",],
       panel = function(x, y, ...) {
         tmp <- lm(y ~ x, na.action = na.omit)
         abline(tmp)
         points(x, y) }, rows = 1)

coplot(NBSSSlope ~ fluorescence | Dbin,
       data = df[df$site2 != "CB",],
       panel = function(x, y, ...) {
         tmp <- lm(y ~ x, na.action = na.omit)
         abline(tmp)
         points(x, y) }, rows = 1)
```


### NA values?

Even though the balance of obs across Dbin-Vbin-site combos is ok, I still choose to omit Vbin because of (1) NAs and (2) correlation with temperature.

```{r,echo=F}
Myvar5 <- c("Biomass","NBSSSlope","NBSSIntercept","Abundance","GeoMn","Temp","fluorescence","oxygen",   
"GA_depth2", "Dbin", "site2", "Vbin")
#look for NA's
dim(df[,Myvar5])
kable(colSums(is.na(df[,Myvar5])),caption = "Number of NA values in each column: all data")
dim(df[df$site2 != "CB",Myvar5])
kable(colSums(is.na(df[df$site2 != "CB",Myvar5])),caption = "Number of NA values in each column: without CB")
```

## Spatial aspects of sampling

It is likely that I don't have data on all variables that are influencing zooplankton. Therefore I will almost certainly have residual spatial autocorrelation after accounting for the effects of the variables that I can inlude in the models.

````{r, echo=F, fig.height = 6, fig.width =15}
xyplot(-Depth ~ Lon | factor(site2), 
       data = df,
       col = 1,
       pch = 16, layout = c(1,4))

par(mfrow=c(2,2))
palette(c("deepskyblue3", "red"))
plot(df[df$site2 == "EH",]$Lon, -df[df$site2 == "EH",]$Depth, col=as.factor(is.na(df[df$site2 == "EH",]$NBSSSlope)), pch=16)
#text(df[df$site2 == "EH",]$Lon, -df[df$site2 == "EH",]$Depth, round(df[df$site2 == "EH",]$NBSSSlope,1), cex=0.9, col=is.na(df[df$site2 == "EH",]$NBSSSlope))

plot(df[df$site2 == "CB",]$Lon, -df[df$site2 == "CB",]$Depth, col=as.factor(is.na(df[df$site2 == "CB",]$NBSSSlope)), pch=16)
#text(df[df$site2 == "CB",]$Lon, -df[df$site2 == "CB",]$Depth, round(df[df$site2 == "CB",]$NBSSSlope,1), cex=0.9, col="purple")

plot(df[df$site2 == "NS",]$Lon, -df[df$site2 == "NS",]$Depth, col=as.factor(is.na(df[df$site2 == "NS",]$NBSSSlope)), pch=16)
#text(df[df$site2 == "NS",]$Lon, -df[df$site2 == "NS",]$Depth, round(df[df$site2 == "NS",]$NBSSSlope,1), cex=0.9, col="purple")

plot(df[df$site2 == "DH",]$Lon, -df[df$site2 == "DH",]$Depth, col=as.factor(is.na(df[df$site2 == "DH",]$NBSSSlope)), pch=16)
#text(df[df$site2 == "DH",]$Lon, -df[df$site2 == "DH",]$Depth, round(df[df$site2 == "DH",]$NBSSSlope,1), cex=0.9, col="purple")

#############
par(mfrow=c(2,2))
palette(c("deepskyblue3", "red"))
plot(df[df$site2 == "EH",]$Lon, -df[df$site2 == "EH",]$Depth, col=as.factor(is.na(df[df$site2 == "EH",]$fluorescence)), pch=16)

plot(df[df$site2 == "CB",]$Lon, -df[df$site2 == "CB",]$Depth, col="red", pch=16)

plot(df[df$site2 == "NS",]$Lon, -df[df$site2 == "NS",]$Depth, col=as.factor(is.na(df[df$site2 == "NS",]$fluorescence)), pch=16)

plot(df[df$site2 == "DH",]$Lon, -df[df$site2 == "DH",]$Depth, col=as.factor(is.na(df[df$site2 == "DH",]$fluorescence)), pch=16)


##########
par(mfrow=c(2,2))
palette(c("deepskyblue3", "red"))
plot(df[df$site2 == "EH",]$Lon, -df[df$site2 == "EH",]$Depth, col=as.factor(is.na(df[df$site2 == "EH",]$Vbin)), pch=16)

plot(df[df$site2 == "CB",]$Lon, -df[df$site2 == "CB",]$Depth, col=as.factor(is.na(df[df$site2 == "CB",]$Vbin)), pch=16)

plot(df[df$site2 == "NS",]$Lon, -df[df$site2 == "NS",]$Depth, col=as.factor(is.na(df[df$site2 == "NS",]$Vbin)), pch=16)

plot(df[df$site2 == "DH",]$Lon, -df[df$site2 == "DH",]$Depth, col=as.factor(is.na(df[df$site2 == "DH",]$Vbin)), pch=16)



```

## Decisisions:

* Site must be treated as a fixed effect. Three factor levels is not enough for a randome intercept (needs to be >6-7)
* My approach now will be to (1) fit GLM, (2) check for overdispersion and non-linear patterns in model residuals, (3) investigate all possible causes of overdispersion, (4) if all else fails then switch to a GAM framework. I can also compare GLM to GAM according to AIC provided the dataframes are exactly equal.
* I have eliminated most of the variables with lots of NAs. Therefore I can probably run models with and without those variables (and their NAs). The 'without' models will also be without CB? I think this only pertains to fluorescense. 
* models will include correlation = corGaus(form = ~ lat+long| site) to account for spatial autocorrelation.
* Keep an eye on a potential Dbin~Temp interaction...data looks a bit sparse across those variables in two dimensions.
* Remember to omit the rows with large discrepancies between Seasoar versus CTD temp/sal (as per Amandine's suggestion)

In summary, these are the variables I am/arn't taking forward in the analyses:

Y variables

* Zooplankton biomass
* Zooplankton abundance
* NBSS slope
* NBSS intercept
* Mean ESD

X variables

* Temperature - no na
* Fluorescence
* Bathymetry - no na
* Sample depth bin (categorical), no na
* Transect site (categorical), no na
	
Omitted X variables

* Salinity
* Nitrate
* Phosphate
* Silicate
* Oxygen
* Distance from coast
* Seafloor slope (categorical)
* Vbin (categorical)

##Save the updated dataset
```{r, eval=F}
write.csv(df, file="data/CleanedData_220519.csv", row.names=FALSE)
```
